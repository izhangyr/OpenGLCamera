#include "ImageFilter.h"

namespace KugouPlayer
{
	ImageFilter::ImageFilter()
		: mFilterType( FILTER_EFFECT_NONE )
	{
		config.Initialize();
	}

	//设置滤镜类型
	void ImageFilter::SetFilterType( int type )
	{
		if( mFilterType == type )//若当前滤镜类型就是将设置的类型,则直接返回
		{
			return;
		}

		mFilterType = type;
		config.Reset();

		switch (type)
			{
			case FILTER_EFFECT_LITTLE_WHITENING:
			{
				uint8 pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.160784 * 255,
					0.247059 * 255, 0.317647 * 255,
					0.372549 * 255, 0.462745 * 255,
					0.498039 * 255, 0.592157 * 255,
					0.623529 * 255, 0.713725 * 255,
					0.749020 * 255, 0.819608 * 255,
					0.874510 * 255, 0.913725 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, pts);
				break;
			}
			case FILTER_EFFECT_MODERATE_WHITENING:
			{
				uint8 pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.192157 * 255,
					0.247059 * 255, 0.372549 * 255,
					0.372549 * 255, 0.529412 * 255,
					0.498039 * 255, 0.666667 * 255,
					0.623529 * 255, 0.784314 * 255,
					0.749020 * 255, 0.874510 * 255,
					0.874510 * 255, 0.945098 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, pts);
				break;
			}
			case FILTER_EFFECT_HIGH_WHITENING:
			{
				uint8 pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.223529 * 255,
					0.247059 * 255, 0.427451 * 255,
					0.372549 * 255, 0.600000 * 255,
					0.498039 * 255, 0.741176 * 255,
					0.623529 * 255, 0.854902 * 255,
					0.749020 * 255, 0.933333 * 255,
					0.874510 * 255, 0.980392 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, pts);
				break;
			}
			case FILTER_EFFECT_LITTLE_PINK:
			{
				uint8 red_pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.160784 * 255,
					0.247059 * 255, 0.317647 * 255,
					0.372549 * 255, 0.462745 * 255,
					0.498039 * 255, 0.592157 * 255,
					0.623529 * 255, 0.713725 * 255,
					0.749020 * 255, 0.819608 * 255,
					0.874510 * 255, 0.913725 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				uint8 pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.145098 * 255,
					0.247059 * 255, 0.290196 * 255,
					0.372549 * 255, 0.427451 * 255,
					0.498039 * 255, 0.556863 * 255,
					0.623529 * 255, 0.678431 * 255,
					0.749020 * 255, 0.792157 * 255,
					0.874510 * 255, 0.898039 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, red_pts);
				break;
			}
			case FILTER_EFFECT_MODERATE_PINK:
			{
				uint8 red_pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.192157 * 255,
					0.247059 * 255, 0.372549 * 255,
					0.372549 * 255, 0.529412 * 255,
					0.498039 * 255, 0.666667 * 255,
					0.623529 * 255, 0.784314 * 255,
					0.749020 * 255, 0.874510 * 255,
					0.874510 * 255, 0.945098 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				uint8 pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.160784 * 255,
					0.247059 * 255, 0.321569 * 255,
					0.372549 * 255, 0.470588 * 255,
					0.498039 * 255, 0.600000 * 255,
					0.623529 * 255, 0.721569 * 255,
					0.749020 * 255, 0.827451 * 255,
					0.874510 * 255, 0.917647 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, red_pts);
				break;
			}
			case FILTER_EFFECT_HIGH_PINK:
			{
				uint8 red_pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.223529 * 255,
					0.247059 * 255, 0.427451 * 255,
					0.372549 * 255, 0.600000 * 255,
					0.498039 * 255, 0.741176 * 255,
					0.623529 * 255, 0.854902 * 255,
					0.749020 * 255, 0.933333 * 255,
					0.874510 * 255, 0.980392 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				uint8 pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.180392 * 255,
					0.247059 * 255, 0.356863 * 255,
					0.372549 * 255, 0.513725 * 255,
					0.498039 * 255, 0.647059 * 255,
					0.623529 * 255, 0.764706 * 255,
					0.749020 * 255, 0.862745 * 255,
					0.874510 * 255, 0.937255 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, red_pts);
				break;
			}
			case FILTER_EFFECT_LITTLE_FLESH:
			{
				uint8 red_pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.160784 * 255,
					0.247059 * 255, 0.317647 * 255,
					0.372549 * 255, 0.462745 * 255,
					0.498039 * 255, 0.592157 * 255,
					0.623529 * 255, 0.713725 * 255,
					0.749020 * 255, 0.819608 * 255,
					0.874510 * 255, 0.913725 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				uint8 green_pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.152941 * 255,
					0.247059 * 255, 0.301961 * 255,
					0.372549 * 255, 0.443137 * 255,
					0.498039 * 255, 0.576471 * 255,
					0.623529 * 255, 0.694118 * 255,
					0.749020 * 255, 0.807843 * 255,
					0.874510 * 255, 0.905882 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				uint8 blue_pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.145098 * 255,
					0.247059 * 255, 0.294118 * 255,
					0.372549 * 255, 0.435294 * 255,
					0.498039 * 255, 0.560784 * 255,
					0.623529 * 255, 0.686275 * 255,
					0.749020 * 255, 0.796078 * 255,
					0.874510 * 255, 0.901961 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, blue_pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, green_pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, red_pts);
				break;
			}
			case FILTER_EFFECT_MODERATE_FLESH:
			{
				uint8 red_pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.192157 * 255,
					0.247059 * 255, 0.372549 * 255,
					0.372549 * 255, 0.529412 * 255,
					0.498039 * 255, 0.666667 * 255,
					0.623529 * 255, 0.784314 * 255,
					0.749020 * 255, 0.874510 * 255,
					0.874510 * 255, 0.945098 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				uint8 green_pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.176471 * 255,
					0.247059 * 255, 0.345098 * 255,
					0.372549 * 255, 0.498039 * 255,
					0.498039 * 255, 0.635294 * 255,
					0.623529 * 255, 0.749020 * 255,
					0.749020 * 255, 0.850980 * 255,
					0.874510 * 255, 0.933333 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				uint8 blue_pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.164706 * 255,
					0.247059 * 255, 0.329412 * 255,
					0.372549 * 255, 0.482353 * 255,
					0.498039 * 255, 0.611765 * 255,
					0.623529 * 255, 0.733333 * 255,
					0.749020 * 255, 0.835294 * 255,
					0.874510 * 255, 0.921569 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, blue_pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, green_pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, red_pts);
				break;
			}
			case FILTER_EFFECT_HIGH_FLESH:
			{
				uint8 red_pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.223529 * 255,
					0.247059 * 255, 0.427451 * 255,
					0.372549 * 255, 0.600000 * 255,
					0.498039 * 255, 0.741176 * 255,
					0.623529 * 255, 0.854902 * 255,
					0.749020 * 255, 0.933333 * 255,
					0.874510 * 255, 0.980392 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				uint8 green_pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.203922 * 255,
					0.247059 * 255, 0.392157 * 255,
					0.372549 * 255, 0.556863 * 255,
					0.498039 * 255, 0.694118 * 255,
					0.623529 * 255, 0.807843 * 255,
					0.749020 * 255, 0.898039 * 255,
					0.874510 * 255, 0.960784 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				uint8 blue_pts[] = {
					0.000000 * 255, 0.007843 * 255,
					0.121569 * 255, 0.188235 * 255,
					0.247059 * 255, 0.368627 * 255,
					0.372549 * 255, 0.529412 * 255,
					0.498039 * 255, 0.662745 * 255,
					0.623529 * 255, 0.780392 * 255,
					0.749020 * 255, 0.874510 * 255,
					0.874510 * 255, 0.945098 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, blue_pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, green_pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, red_pts);
				break;
			}
			case FILTER_EFFECT_RAINBOW_GRADIENT:
			{
				uint8 red_pts[] = {
					0.000000 * 255, 0.024183 * 255,
					0.121569 * 255, 0.048308 * 255,
					0.247059 * 255, 0.154831 * 255,
					0.372549 * 255, 0.314038 * 255,
					0.498039 * 255, 0.497584 * 255,
					0.623529 * 255, 0.683345 * 255,
					0.749020 * 255, 0.841507 * 255,
					0.874510 * 255, 0.957243 * 255,
					1.000000 * 255, 0.997723 * 255,
				};
				uint8 green_pts[] = {
					0.000000 * 255, 0.010784 * 255,
					0.121569 * 255, 0.042665 * 255,
					0.247059 * 255, 0.155542 * 255,
					0.372549 * 255, 0.319728 * 255,
					0.498039 * 255, 0.499008 * 255,
					0.623529 * 255, 0.686299 * 255,
					0.749020 * 255, 0.843454 * 255,
					0.874510 * 255, 0.957699 * 255,
					1.000000 * 255, 0.999459 * 255,
				};
				uint8 blue_pts[] = {
					0.000000 * 255, 0.005853 * 255,
					0.121569 * 255, 0.043693 * 255,
					0.247059 * 255, 0.154759 * 255,
					0.372549 * 255, 0.318024 * 255,
					0.498039 * 255, 0.499930 * 255,
					0.623529 * 255, 0.681052 * 255,
					0.749020 * 255, 0.850097 * 255,
					0.874510 * 255, 0.959228 * 255,
					1.000000 * 255, 0.994901 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, blue_pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, green_pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, red_pts);
				break;
			}
			case FILTER_EFFECT_CLASSIC_HDR:
			{
				uint8 red_pts[] = {
					0.000000 * 255, 0.054902 * 255, 
					0.121569 * 255, 0.070588 * 255, 
					0.247059 * 255, 0.243137 * 255, 
					0.372549 * 255, 0.407843 * 255,
					0.498039 * 255, 0.552941 * 255, 
					0.623529 * 255, 0.678431 * 255,
					0.749020 * 255, 0.780392 * 255, 
					0.874510 * 255, 0.866667 * 255,
					1.000000 * 255, 0.949020 * 255,
				};
				uint8 green_pts[] = {
					0.000000 * 255, 0.007843 * 255, 
					0.121569 * 255, 0.023529 * 255,
					0.247059 * 255, 0.207843 * 255, 
					0.372549 * 255, 0.388235 * 255,
					0.498039 * 255, 0.541176 * 255, 
					0.623529 * 255, 0.682353 * 255,
					0.749020 * 255, 0.796078 * 255, 
					0.874510 * 255, 0.898039 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				uint8 blue_pts[] = {
					0.000000 * 255, 0.258824 * 255, 
					0.121569 * 255, 0.294118 * 255,
					0.247059 * 255, 0.372549 * 255, 
					0.372549 * 255, 0.450980 * 255,
					0.498039 * 255, 0.521569 * 255, 
					0.623529 * 255, 0.592157 * 255,
					0.749020 * 255, 0.654902 * 255, 
					0.874510 * 255, 0.717647 * 255,
					1.000000 * 255, 0.776471 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, blue_pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, green_pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, red_pts);
				break;
			}
			case FILTER_EFFECT_YELLOWING_DARK_CORNERS:
			{
				uint8 red_pts[] = {
					0.000000 * 255, 0.093137 * 255,
					0.121569 * 255, 0.125134 * 255,
					0.247059 * 255, 0.227000 * 255,
					0.372549 * 255, 0.372794 * 255,
					0.498039 * 255, 0.537491 * 255,
					0.623529 * 255, 0.706434 * 255,
					0.749020 * 255, 0.852155 * 255,
					0.874510 * 255, 0.953969 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				uint8 green_pts[] = {
					0.000000 * 255, 0.092647 * 255,
					0.121569 * 255, 0.125205 * 255,
					0.247059 * 255, 0.227129 * 255,
					0.372549 * 255, 0.372871 * 255,
					0.498039 * 255, 0.537711 * 255,
					0.623529 * 255, 0.706357 * 255,
					0.749020 * 255, 0.851153 * 255,
					0.874510 * 255, 0.953240 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				uint8 blue_pts[] = {
					0.000000 * 255, 0.003922 * 255,
					0.121569 * 255, 0.029810 * 255,
					0.247059 * 255, 0.143778 * 255,
					0.372549 * 255, 0.305764 * 255,
					0.498039 * 255, 0.488796 * 255,
					0.623529 * 255, 0.672134 * 255,
					0.749020 * 255, 0.833704 * 255,
					0.874510 * 255, 0.948010 * 255,
					1.000000 * 255, 0.996078 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, blue_pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, green_pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, red_pts);
				break;
			}
			case FILTER_EFFECT_PINK_LADY:
			{
				uint8 red_pts[] = {
					0.000000 * 255, 0.003922 * 255,
					0.121569 * 255, 0.196078 * 255,
					0.247059 * 255, 0.356863 * 255,
					0.372549 * 255, 0.509804 * 255,
					0.498039 * 255, 0.647059 * 255,
					0.623529 * 255, 0.760784 * 255,
					0.749020 * 255, 0.858824 * 255,
					0.874510 * 255, 0.937255 * 255,
					1.000000 * 255, 1.000000 * 255,
				};
				uint8 green_pts[] = {
					0.000000 * 255, 0.003922 * 255,
					0.121569 * 255, 0.180392 * 255,
					0.247059 * 255, 0.329412 * 255,
					0.372549 * 255, 0.478431 * 255,
					0.498039 * 255, 0.611765 * 255,
					0.623529 * 255, 0.729412 * 255,
					0.749020 * 255, 0.831373 * 255,
					0.874510 * 255, 0.921569 * 255,
					1.000000 * 255, 1.000000 * 255,
				};
				uint8 blue_pts[] = {
					0.000000 * 255, 0.003922 * 255,
					0.121569 * 255, 0.168627 * 255,
					0.247059 * 255, 0.317647 * 255,
					0.372549 * 255, 0.458824 * 255,
					0.498039 * 255, 0.592157 * 255,
					0.623529 * 255, 0.709804 * 255,
					0.749020 * 255, 0.819608 * 255,
					0.874510 * 255, 0.913725 * 255,
					1.000000 * 255, 1.000000 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, blue_pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, green_pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, red_pts);
				break;
			}
			case FILTER_EFFECT_ICE_SPIRIT:
			{
				uint8 red_pts[] = {
					0.000000 * 255, 0.007843 * 255, 
					0.121569 * 255, 0.141176 * 255,
					0.247059 * 255, 0.286275 * 255, 
					0.372549 * 255, 0.423529 * 255,
					0.498039 * 255, 0.552941 * 255, 
					0.623529 * 255, 0.674510 * 255,
					0.749020 * 255, 0.792157 * 255, 
					0.874510 * 255, 0.898039 * 255,
					1.000000 * 255, 1.000000 * 255,
				};
				uint8 green_pts[] = {
					0.000000 * 255, 0.007843 * 255, 
					0.121569 * 255, 0.184314 * 255,
					0.247059 * 255, 0.360784 * 255, 
					0.372549 * 255, 0.517647 * 255,
					0.498039 * 255, 0.654902 * 255, 
					0.623529 * 255, 0.768627 * 255,
					0.749020 * 255, 0.866667 * 255, 
					0.874510 * 255, 0.945098 * 255,
					1.000000 * 255, 1.000000 * 255,
				};
				uint8 blue_pts[] = {
					0.000000 * 255, 0.007843 * 255, 
					0.121569 * 255, 0.211765 * 255,
					0.247059 * 255, 0.407843 * 255, 
					0.372549 * 255, 0.576471 * 255,
					0.498039 * 255, 0.717647 * 255, 
					0.623529 * 255, 0.827451 * 255,
					0.749020 * 255, 0.913725 * 255, 
					0.874510 * 255, 0.972549 * 255,
					1.000000 * 255, 1.000000 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, blue_pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, green_pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, red_pts);
				break;
			}
			case FILTER_EFFECT_NIGHT_VIEW:
			{
				uint8 red_pts[] = {
					0.000000 * 255, 0.003922 * 255,
					0.121569 * 255, 0.181978 * 255,
					0.247059 * 255, 0.348183 * 255,
					0.372549 * 255, 0.498116 * 255,
					0.498039 * 255, 0.630567 * 255,
					0.623529 * 255, 0.746150 * 255,
					0.749020 * 255, 0.848447 * 255,
					0.874510 * 255, 0.939235 * 255,
					1.000000 * 255, 1.000000 * 255,
				};
				uint8 green_pts[] = {
					0.000000 * 255, 0.002451 * 255,
					0.121569 * 255, 0.182281 * 255,
					0.247059 * 255, 0.347678 * 255,
					0.372549 * 255, 0.495968 * 255,
					0.498039 * 255, 0.629733 * 255,
					0.623529 * 255, 0.747508 * 255,
					0.749020 * 255, 0.852278 * 255,
					0.874510 * 255, 0.937573 * 255,
					1.000000 * 255, 1.000000 * 255,
				};
				uint8 blue_pts[] = {
					0.000000 * 255, 0.005240 * 255,
					0.121569 * 255, 0.182529 * 255,
					0.247059 * 255, 0.347919 * 255,
					0.372549 * 255, 0.496757 * 255,
					0.498039 * 255, 0.638620 * 255,
					0.623529 * 255, 0.753394 * 255,
					0.749020 * 255, 0.852676 * 255,
					0.874510 * 255, 0.948770 * 255,
					1.000000 * 255, 1.000000 * 255,
				};
				config.CurvesSpline(CURVE_CHANNEL_B, 18, blue_pts);
				config.CurvesSpline(CURVE_CHANNEL_G, 18, green_pts);
				config.CurvesSpline(CURVE_CHANNEL_R, 18, red_pts);
				break;
			}
			default:
				//assert(0);
				return;
			}

			config.Calculate();
	}

	//图像滤镜处理
	void ImageFilter::Process( unsigned char * buffer, int width, int height )
	{
		if( mFilterType != FILTER_EFFECT_NONE )
		{
			int bytesPerPixel = 4;
			int lineBytes = WIDTHBYTES(width * 32);//保证图像每一行的字节数是4的整数倍
			int offset = 0;
			//璋撮
			for (int y = 0; y < height; y++)
			{
				byte *p = buffer + offset;

				for (int x = 0; x < width; x++)
				{
#if 0
					*(p + 0) = config.curves[CURVE_CHANNEL_B]->GetValue(*(p + 0));
					*(p + 1) = config.curves[CURVE_CHANNEL_G]->GetValue(*(p + 1));
					*(p + 2) = config.curves[CURVE_CHANNEL_R]->GetValue(*(p + 2));
#else

					//此处由于之前一点点失误，曲线选择的时候弄颠倒了B和R通道的顺序
					*(p + 0) = config.curves[CURVE_CHANNEL_R]->GetValue(*(p + 0));
					*(p + 1) = config.curves[CURVE_CHANNEL_G]->GetValue(*(p + 1));
					*(p + 2) = config.curves[CURVE_CHANNEL_B]->GetValue(*(p + 2));
#endif
					p += bytesPerPixel;
				}

				offset += lineBytes;
			}
		}
	}
}
